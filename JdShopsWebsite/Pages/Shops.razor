@page "/shops"
@using System.Net.Http
@using System.Net
@using System.Security.Policy
@using Bunit.Extensions
@using Flurl
@using Url = Flurl.Url
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager navigationManager



<div><h1>List of Shops</h1></div>



@if (shops == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="form-group">
        <input class="form-control" type="text" placeholder="Search by Shop Number...."
               @bind="Filter"
               @bind:event="oninput">
    </div>
    <table class="table table-striped">
        <thead class="thead-light">
            <tr>
                <th>Shop Number</th>
                <th>Facia</th>
                <th>Town</th>
                <th>Phone Number</th>
                <th>More Details</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var shop in shops)
            {
                if (!IsVisible(shop))
                {
                    continue;
                }

                <tr>
                    <td style="font-weight: bold">@shop.ShopNumber</td>
                    <td style=""><img src="logos/@(shop.Facia + ".png")" alt="@shop.Facia" width="110px" height="60px" /></td>
                    <td style="font-weight: bold">@shop.Town</td>
                    <td><button class="btn btn-primary" a href="tel:@shop.PhoneNumber">Call the shop on @shop.PhoneNumber</button></td>
                    <td><button class="btn btn-primary" @onclick="()=>NavigateToShopDetails(shop.ShopNumber)"> More details </button></td>

                </tr>

            }
        </tbody>
    </table>

}


@code
{
   
    private List<ShopDto> shops;

    protected override async Task OnInitializedAsync()
    {
        shops = await Http.GetFromJsonAsync<List<ShopDto>>($"https://jdshops-api-app.azurewebsites.net/api/shops");

    }

    //<td><button class="btn btn-primary" @onclick="()=>NavigateToShopDetails(shop.ShopNumber)"> More details </button></td>




    private void NavigateToShopDetails(float id)
    {

        var url = Url.Combine("https://jdshops-api-app.azurewebsites.net/api/shops/", id.ToString());
        var shop = Http.GetFromJsonAsync<List<ShopDto>>(url);
        var url2 = Url.Combine($"/shopDetails/", id.ToString());
        navigationManager.NavigateTo(url2, true);

    }



    public bool IsVisible(ShopDto shop)
    {

        if (string.IsNullOrEmpty(Filter))
        {
            return true;
        }


        if (shop.ShopNumber.ToString().ToLower().Contains(Filter.ToLower()))
        {
            return true;

        }

        return false;
    }

    public string Filter { get; set; }


}

